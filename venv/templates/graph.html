<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Graph</title>
  <link rel="icon" href="../static/house-solid.svg" type="image/x-icon">

  {% include 'link.html' %}


</head>

<body class="bg-gray-900">

  {% include 'navbar.html' %}
  <div id="particles-js" style="height: 185vh;width: 100vw;z-index: -50; position: fixed; top: 0;">


  </div>

    <div class="justify-center flex mb-5 mt-5 fade-in">
      <div class="input-group flex-nowrap mt-2 " style="width: 30vw;">
        <span class="input-group-text bg-gray-600 text-white border-none" id="addon-wrapping"><i
            class="bi bi-building"></i></span>
        <select class="form-select bg-gray-600 text-white border-none" name="" id="salle">
          <option value="D251">D251</option>
          <option value="D351">D351</option>
          <option value="D360">D360</option>
          <option value="S10">Tetras (S10)</option>
          <option value="S15">Tetras (S15)</option>

  
  
  
        </select>
        
      </div>
      <div class="input-group flex-nowrap mt-2 ml-2 " style="width: 10vw;">
        <span class="input-group-text bg-gray-600 text-white border-none" id="addon-wrapping"><i class="bi bi-clock-history"></i></span>
        <select class="form-select bg-gray-600 text-white border-none" name="" id="temps">
          <option value="1h">1h</option>
          <option value="3h">3h</option>
          <option value="6h">6h</option>
          <option value="12h">12h</option>
          <option value="24h">24h</option>
          <option value="2d">2d</option>


  
  
  
        </select>
        
      </div>
    </div>

  <div class="flex justify-center  align-items-start   " >

    <div class="grid grid-cols-2 gap-14 pr-5 fade-in" style="height: 80vh; overflow: auto;">

      <div id="container" class="bg-gray-800 rounded " style="height: 40vh; width: fit-content;">
        <h1 class="text-white p-3 flex justify-center" style="width: 40vw;">Temperature (°C)</h1>
        <div id="temperature" class=" w-full" style="height: 30vh;" ></div>
        <!-- <canvas  class="p-5 temperature" style="height: 28vh; width: 40vw;"></canvas> -->
      </div>

      <div id="container" class="bg-gray-800 rounded " style="height:40vh ; width: fit-content;">
        <h1 class="text-white p-3 flex justify-center" style="width: 40vw;">CO2 (ppm)</h1>
        <div id="CO2" class=" w-full" style="height: 30vh;" ></div>
      </div>

      <div id="container" class="bg-gray-800 rounded 0" style="height: 40vh; width: fit-content;">
        <h1 class="text-white p-3 flex justify-center" style="width: 40vw;">Luminosité (lx)</h1>

        <div id="Luminosité" class=" w-full" style="height: 30vh;" ></div>
      </div>

      <div id="container_bruit" class="bg-gray-800 rounded " style="height: 40vh; width: fit-content;">
        <h1 class="text-white p-3 flex justify-center" style="width: 40vw;">Bruit (db)</h1>

        <div id="Bruit" class=" w-full" style="height: 30vh;" ></div>
      </div>
      <div id="container_humidite" class="bg-gray-800 rounded " style="height: 40vh; width: fit-content;">
        <h1 class="text-white p-3 flex justify-center" style="width: 40vw;">Humidité (%)</h1>

        <div id="humidite" class=" w-full" style="height: 30vh;" ></div>
      </div>
      <div id="container_UV" class="bg-gray-800 rounded" style="height: 40vh; width: fit-content;">
        <h1 class="text-white p-3 flex justify-center" style="width: 40vw;">Ultras Violet (UV)</h1>

        <div id="UV" class=" w-full" style="height: 30vh;" ></div>
      </div>
      <div id="container_µg" class="bg-gray-800 rounded" style="height: 40vh; width: fit-content;">
        <h1 class="text-white p-3 flex justify-center" style="width: 40vw;">Qualité de l'air (µg/m³)</h1>

        <div id="µg" class=" w-full" style="height: 30vh;" ></div>
      </div>
    </div>
  </div>








  </div>


  {% include 'link_js.html' %}







</body>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>


<script>
  
  document.addEventListener("DOMContentLoaded", function () {
    var host = window.location.hostname;
    function create_graph(color,classgraph)
    {
        var name = new Chart($(classgraph), {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            data: [],
            borderWidth: 2,
            borderColor: color,
            backgroundColor: color

          }]
        },
        options: {
          responsive: true,

          scales: {
            y: {
              ticks: {
                color: 'white'
              }
            },
            x: {
              ticks: {
                color: 'white'
              }
            }
          },
          legend: {
            labels: {
              fontColor: 'white' // Définir la couleur du texte de la légende
            }
          }
        }
      });

    return name
    }
    function create_graph2(color, classgraph) {
      TESTER = document.getElementById(classgraph);
       // Définir le type de trace par défaut comme "scatter"
      var trace = {
        x: [],
        y: [],
        line: { color: color },
        mode: 'lines+markers'
        
      };
      var traceType = 'scatter';

      if (traceType) {
        trace.type = traceType;
      }
      var graph = Plotly.newPlot(TESTER, [trace], {
        padding: { t: 5, l: 5, r: 5, b: 5 },
        margin:{t:20},
        animate: true, // Active l'animation
 // Ajoutez le padding en ajustant ces valeurs
        paper_bgcolor: 'rgb(45, 55, 72)',
        plot_bgcolor: 'rgb(45, 55, 72)',  // Définir la couleur du fond
        xaxis: {
          tickfont: { color: 'white' }  // Couleur du texte pour l'axe x
        },
        yaxis: {
          tickfont: { color: 'white' }  // Couleur du texte pour l'axe y
        }
      });

      console.log(graph);  // Afficher l'objet graph dans la console

      return graph;
    }



    function updateChart(barChart) {
      barChart.data.datasets[0].label = capteur;
      barChart.data.labels = times;
      barChart.data.datasets[0].data = values;
      barChart.update();
      // Mettre à jour le graphique sans le recréer
    }
    function updateChart2(barChart, newDataX, newDataY) {
      console.log('datax : ', newDataX, '    datay : ', newDataY);
      console.log(barChart);
      Plotly.animate(barChart, {
        data: [{ x: newDataX, y: newDataY }],
      }, {
        transition: {
          duration: 500, // Durée de l'animation en millisecondes
          easing: 'cubic-in-out', // Fonction d'interpolation pour l'animation
        },
      });
      // Mettre à jour les données de la première trace (indice 0) dans barChart, pas dans une variable appelée 'graph'
      barChart.data[0].x = newDataX;
      barChart.data[0].y = newDataY;

      // Redessiner le graphique
      Plotly.redraw(barChart);
    }


    function extractPromiseValue(promise) {
      return promise.then(value => value);
    }

    // Modifiez votre code pour extraire la valeur résolue de la promesse
    // var legraphPromise = create_graph2('white', '.temperature');
    var legraph;





    
    var barChartTemperature = create_graph2('rgb(173, 216, 230)','temperature')
    var barChartCO2 = create_graph2('rgb(255, 255, 240)','CO2')
    var barChartHumidite = create_graph2('white','humidite')
    var barChartUV = create_graph2('purple','UV')
    var barChartLuminosité = create_graph2('rgb(255, 182, 193)','Luminosité')
    var barChartBruit = create_graph2('rgb(144, 238, 144)','Bruit')
    var barChartµg = create_graph2('rgb(144, 238, 144)','µg')




    // Initialiser le graphique une seule fois
   
    

      
      
    var temps = $('#temps').val()

    var eventSourceD251 = new EventSource(`http://${host}:34/get_data/d251/temperature/${temps}`);
    var eventSource_D251_CO2 = new EventSource(`http://${host}:34/get_data/d251/CO2/${temps}`);
    var eventSource_D251_Lx = new EventSource(`http://${host}:34/get_data/d251/luminosite/${temps}`);
    var eventSource_D251_pc = new EventSource(`http://${host}:34/get_data/d251/humidite/${temps}`);
    var eventSource_D251_UV = new EventSource(`http://${host}:34/get_data/d251/UV/${temps}`);



    $('#container_bruit').hide();
    $('#container_µg').hide();
    add_Data_toGraph(eventSourceD251, barChartTemperature)
    add_Data_toGraph(eventSource_D251_CO2, barChartCO2)
    add_Data_toGraph(eventSource_D251_Lx, barChartLuminosité)
    add_Data_toGraph(eventSource_D251_pc, barChartHumidite)
    add_Data_toGraph(eventSource_D251_UV, barChartUV)





    $('#salle').change(() => {
      var temps = $('#temps').val()

      if ($('#salle').val() == 'D251') {
        var eventSourceD251 = new EventSource(`http://${host}:34/get_data/d251/temperature/${temps}`);
        var eventSource_D251_CO2 = new EventSource(`http://${host}:34/get_data/d251/CO2/${temps}`);
        var eventSource_D251_Lx = new EventSource(`http://${host}:34/get_data/d251/luminosite/${temps}`);
        var eventSource_D251_pc = new EventSource(`http://${host}:34/get_data/d251/humidite/${temps}`);
        var eventSource_D251_UV = new EventSource(`http://${host}:34/get_data/d251/UV/${temps}`);

        
        $('#container_bruit').hide();
        $('#container_µg').hide();



        add_Data_toGraph(eventSourceD251, barChartTemperature)
        add_Data_toGraph(eventSource_D251_CO2, barChartCO2)
        add_Data_toGraph(eventSource_D251_Lx, barChartLuminosité)
        add_Data_toGraph(eventSource_D251_pc, barChartHumidite)
        add_Data_toGraph(eventSource_D251_UV, barChartUV)




      }
      if ($('#salle').val() == 'D351') {
        var eventSourceD351 = new EventSource(`http://${host}:34/get_data/d351/temperature/${temps}`);
        var eventSource_D351_CO2 = new EventSource(`http://${host}:34/get_data/d351/CO2/${temps}`);
        var eventSource_D351_Lx = new EventSource(`http://${host}:34/get_data/d351/luminosite/${temps}`);
        var eventSource_D351_db = new EventSource(`http://${host}:34/get_data/d351/bruit/${temps}`);
        var eventSource_D351_pc = new EventSource(`http://${host}:34/get_data/d351/humidite/${temps}`);
        var eventSource_D351_UV = new EventSource(`http://${host}:34/get_data/d351/UV/${temps}`);
        var eventSource_D351_µg = new EventSource(`http://${host}:34/get_data/d351/µg/${temps}`);




        $('#container_bruit').show();
        $('#container_UV').show();
        $('#container_µg').show();



        add_Data_toGraph(eventSource_D351_pc, barChartHumidite)
        add_Data_toGraph(eventSource_D351_CO2, barChartCO2)
        add_Data_toGraph(eventSourceD351, barChartTemperature)
        add_Data_toGraph(eventSource_D351_Lx, barChartLuminosité)
        add_Data_toGraph(eventSource_D351_db, barChartBruit)
        add_Data_toGraph(eventSource_D351_UV, barChartUV)
        add_Data_toGraph(eventSource_D351_µg, barChartµg)






      }
      if ($('#salle').val() == 'D360') {

        var eventSourceD360 = new EventSource(`http://${host}:34/get_data/d360/temperature/${temps}`);
        var eventSource_D360_CO2 = new EventSource(`http://${host}:34/get_data/d360/CO2/${temps}`);
        var eventSource_D360_Lx = new EventSource(`http://${host}:34/get_data/d360/luminosite/${temps}`);
        var eventSource_D360_pc = new EventSource(`http://${host}:34/get_data/d360/humidite/${temps}`);
        var eventSource_D360_UV = new EventSource(`http://${host}:34/get_data/d360/UV/${temps}`);





        $('#container_bruit').hide();
        $('#container_µg').hide();



        add_Data_toGraph(eventSourceD360, barChartCO2)
        add_Data_toGraph(eventSource_D360_CO2, barChartTemperature)
        add_Data_toGraph(eventSource_D360_Lx, barChartLuminosité)
        add_Data_toGraph(eventSource_D360_pc, barChartHumidite)
        add_Data_toGraph(eventSource_D360_UV, barChartUV)





      }
    })


    $('#temps').change(() => {
      var temps = $('#temps').val()
      if ($('#salle').val() == 'D251') {
        var eventSourceD251 = new EventSource(`http://${host}:34/get_data/d251/temperature/${temps}`);
        var eventSource_D251_CO2 = new EventSource(`http://${host}:34/get_data/d251/CO2/${temps}`);
        var eventSource_D251_Lx = new EventSource(`http://${host}:34/get_data/d251/luminosite/${temps}`);
        var eventSource_D251_pc = new EventSource(`http://${host}:34/get_data/d251/humidite/${temps}`);
        var eventSource_D251_UV = new EventSource(`http://${host}:34/get_data/d251/UV/${temps}`);

        
        $('#container_bruit').hide();
        $('#container_µg').hide();



        add_Data_toGraph(eventSourceD251, barChartTemperature)
        add_Data_toGraph(eventSource_D251_CO2, barChartCO2)
        add_Data_toGraph(eventSource_D251_Lx, barChartLuminosité)
        add_Data_toGraph(eventSource_D251_pc, barChartHumidite)
        add_Data_toGraph(eventSource_D251_UV, barChartUV)




      }
      if ($('#salle').val() == 'D351') {
        var eventSourceD351 = new EventSource(`http://${host}:34/get_data/d351/temperature/${temps}`);
        var eventSource_D351_CO2 = new EventSource(`http://${host}:34/get_data/d351/CO2/${temps}`);
        var eventSource_D351_Lx = new EventSource(`http://${host}:34/get_data/d351/luminosite/${temps}`);
        var eventSource_D351_db = new EventSource(`http://${host}:34/get_data/d351/bruit/${temps}`);
        var eventSource_D351_pc = new EventSource(`http://${host}:34/get_data/d351/humidite/${temps}`);
        var eventSource_D351_UV = new EventSource(`http://${host}:34/get_data/d351/UV/${temps}`);
        var eventSource_D351_µg = new EventSource(`http://${host}:34/get_data/d351/µg/${temps}`);




        $('#container_bruit').show();
        $('#container_UV').show();
        $('#container_µg').show();



        add_Data_toGraph(eventSource_D351_pc, barChartHumidite)
        add_Data_toGraph(eventSource_D351_CO2, barChartCO2)
        add_Data_toGraph(eventSourceD351, barChartTemperature)
        add_Data_toGraph(eventSource_D351_Lx, barChartLuminosité)
        add_Data_toGraph(eventSource_D351_db, barChartBruit)
        add_Data_toGraph(eventSource_D351_UV, barChartUV)
        add_Data_toGraph(eventSource_D351_µg, barChartµg)






      }
      if ($('#salle').val() == 'D360') {

        var eventSourceD360 = new EventSource(`http://${host}:34/get_data/d360/temperature/${temps}`);
        var eventSource_D360_CO2 = new EventSource(`http://${host}:34/get_data/d360/CO2/${temps}`);
        var eventSource_D360_Lx = new EventSource(`http://${host}:34/get_data/d360/luminosite/${temps}`);
        var eventSource_D360_pc = new EventSource(`http://${host}:34/get_data/d360/humidite/${temps}`);
        var eventSource_D360_UV = new EventSource(`http://${host}:34/get_data/d360/UV/${temps}`);





        $('#container_bruit').hide();
        $('#container_µg').hide();



        add_Data_toGraph(eventSourceD360, barChartCO2)
        add_Data_toGraph(eventSource_D360_CO2, barChartTemperature)
        add_Data_toGraph(eventSource_D360_Lx, barChartLuminosité)
        add_Data_toGraph(eventSource_D360_pc, barChartHumidite)
        add_Data_toGraph(eventSource_D360_UV, barChartUV)





      }
    })

    function add_Data_toGraph(eventSource, barChart) {
      var compt = 0

      eventSource.onmessage = function (event) {
        var data = JSON.parse(event.data);



        // Traiter les données reçues
        console.log(data)

        console.log(data[0])
        values = data.map(item => item.value);
        times = data.map(item => formatTime(item.time));
        capteur = data[0].entity;


        console.log(values)
        console.log(times)
        console.log(capteur)




        compt++;
        // Mettre à jour le graphique après avoir reçu des données
        // updateChart(barChart);
        extractPromiseValue(barChart).then(resolvedValue => {
          legraph = resolvedValue;

          // Supposons que vous ayez de nouvelles données
          var nouvellesDonneesX = times;
          var nouvellesDonneesY = values;

          // Appelez la fonction de mise à jour avec les nouvelles données
          updateChart2(legraph, nouvellesDonneesX, nouvellesDonneesY);
        });
        
        if (compt == 1) {
          eventSource.close();
        }
      };
    }



    function formatTime(dateString) {
      var date = new Date(dateString);
      var hours = date.getUTCHours();
      var minutes = date.getUTCMinutes();
      var seconds = date.getUTCSeconds();

      // Formater en HH:mm:ss
      var formattedTime = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
      return formattedTime;
    }
    // Fonction pour mettre à jour le graphique avec les nouvelles données




  });



</script>

</html>